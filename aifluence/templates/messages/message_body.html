{% for channel_message in channel_messages %}
<div class="row">
    <div class="col-md-12">
        <div class="row">
            <div class="col-md-3 {% if channel_message.sent_by_id != user.id %}text-success{% endif %}">
                <span class="channel-user">
                    {{channel_message.sent_by.first_name|slice:"0:1"|upper}}{{channel_message.sent_by.last_name|slice:"0:1"|upper}}
                </span>  
                <span>{{channel_message.sent_by.first_name|title }} {{channel_message.sent_by.last_name|title }}</span>
            </div>
        </div>
        <div class="row mt-1">
            <div class="col-md-10 {% if channel_message.sent_by  != request.user %}received-message{% endif %}" data-id="{{channel_message.id}}" data-read="{{channel_message.read_status}}" data-discussion="{{channel_message.discussion.id}}">
                {% if forloop.counter == 1 %}
                    <span class="ml-5">Brand Name: {{ channel_message.discussion.campaign.brand_name }}</span><br>
                    <span class="ml-5">Brand Category: {% for category in channel_message.discussion.campaign.brand_category %} {{category.0}} {% endfor %}</span><br/>
                    <span class="ml-5">Brand Attributes: {{ channel_message.discussion.campaign.brand_attributes }}</span><br/>
                    <span class="ml-5">Key Selling Point: {{ channel_message.discussion.campaign.key_selling_point }}</span><br/>
                    <span class="ml-5">Brief: {{ channel_message.discussion.campaign.campaign_brief}}</span><br/>
                    <span class="ml-5">Location: {% for ll in channel_message.discussion.campaign.location %} {ll.0} {% empty %} All over the world {% endfor %}</span><br/>
                    <p class="ml-5 mt-2"> We highly recommend you to use the posting style of <span class="text-success">{{ channel_message.content }}</span> for this campaign after carefully matching your expeirences & campaign details.</p>
                {% else %}
                    <p class="ml-5 message-row" data-id="{{channel_message.id}}">{{ channel_message.content|safe }}</p>
                {% endif %}
            </div>
            <div class="col-md-2">
                <small>{{ channel_message.sent_at|date:'d M H:i' }}</small>
            </div>
        </div>
    </div>
</div>
{% endfor %}
<script>
    $(document).ready(function(){

        $.ajaxSetup({
            headers:
                { 'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val() }
        });

        $(".received-message").on('click', function() {
            
            if ($(this).attr('data-read') == 'False') {
                $(this).attr('data-read', 'True')
                
                var num = $("#discussion_notify").html()
                if (num=="1") {
                    var element = document.getElementById("discussion_notify");
                    element.parentNode.removeChild(element);    
                }else{
                    $("#discussion_notify").html(parseInt(num)-1)
                }
                
                var current_discussion_notify = $(".current-discussion-notify[data-id='"+$(this).attr('data-discussion')+"']")
                console.log(current_discussion_notify)
                var current_discussion_num = current_discussion_notify.html()
                console.log(current_discussion_num)
                if (current_discussion_num=="1") {
                    current_discussion_notify.remove() 
                } else{
                    current_discussion_notify.html(parseInt(current_discussion_num) - 1)
                }
                
                $.ajax({
                    url: "/messages/" + $(this).attr('data-id') + "/read",
                    method: 'post',
                    success: function(data){
                    }
                })
            }
        })
    });
</script>